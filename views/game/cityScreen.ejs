<%
    let cityGold = 0;
    let cityFood = 0;
    let cityProduction = 0;

    city.buildings.forEach(i => {
        cityGold += buildingTypes[i].gold;
        cityFood += buildingTypes[i].food;
        cityProduction += buildingTypes[i].production;
    });

    const growthRate = [0, 15, 22, 30, 40, 51, 63, 76, 90, 105, 121, 138, 155, 174, 194, 214, 235,
        258, 280, 304, 329, 354, 380, 407, 435, 464, 493, 523, 554, 585, 617, 650, 684, 719, 754,
        790, 826, 863, 901, 940, 979];

    let foodNeededForGrowth = growthRate[city.population];
%>

<div class="info city" city-id="<%= city._id %>">
    <div class="close">X</div>
    <div>city</div>
    <div>
        population: <%= city.population %><br/>
        (<%= city.food %> / <%= foodNeededForGrowth %>)
    </div>
    <div>
        gold: <%= cityGold %><br/>
        food: <%= cityFood %><br/>
        production: <%= cityProduction %><br/>
    </div>
    <div>
        buildings:
        <ul>
            <% city.buildings.forEach(i => { %>
                <li><%= buildingTypes[i].name %></li>
            <% }); %>
        </ul>
    </div>
    <div>
        <%
            let currentProject = '_______';
            let productionTotal = 0;
            let progress = 0;
            let turnsToFinish = 0;

            if (city.project.category) {
                if (city.project.category == 'unit') {
                    currentProject = unitTypes[city.project.index].name;
                    productionTotal = unitTypes[city.project.index].cost;
                } else if (city.project.category == 'building') {
                    currentProject = buildingTypes[city.project.index].name;
                    productionTotal = buildingTypes[city.project.index].cost;
                }
                progress = city.projectProgress[city.project.category][city.project.index];
                progress += city.productionRollover;
                turnsToFinish = Math.ceil((productionTotal - progress) / cityProduction);
            }
        %>
        current construction:
        <%= currentProject %>
        <% if (productionTotal) { %>
            (<%= progress %> / <%= productionTotal %>)
            <br/>
            <%= turnsToFinish %> turns to finish
        <% } %>
    </div>
    <div>
        change construction:
        <ul>
            <% unitTypes.forEach((unitType, i) => { %>
                <%
                    let path = '/changeProject/' + city._id + '/unit/' + i;
                %>
                <li>
                    <a href="<%= path %>"><%= unitType.name %></a>
                </li>
            <% }); %>
            <% buildingTypes.forEach((buildingType, i) => { %>
                <%
                    if (city.buildings.indexOf(i) >= 0) {
                        return;
                    }
                    let path = '/changeProject/' + city._id + '/building/' + i;
                %>
                <li>
                    <a href="<%= path %>"><%= buildingType.name %></a>
                </li>
            <% }); %>
        </ul>
    </div>
</div>
