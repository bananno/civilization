<%
    let tile = cell.tile;

    let tileStack = [];

    let food = tile.food;
    let gold = tile.gold;

    let clickable = false;
    let onClick = null;

    let className = 'map-cell boardnum-' + boardnum;

    let allowTileEntry = true;

    if (boardnum != 1) {
        className += ' off-screen';
    }

    if (cell.lit || cell.owned || cell.discovered) {

        tileStack.push('ground ground-' + tile.terrain.ground);

        if (tile.terrain.mountain) {
            tileStack.push('mountain');
        } else {
            if (tile.terrain.hill) {
                tileStack.push('hill');
            }
            if (tile.terrain.forest) {
                tileStack.push('forest');
            }
        }

        if (cell.player) {
            className += ' player' + cell.player;
            tileStack.push('territory territory-' + cell.player);
        }

        if (tile.improvement) {
            let improvementName = tile.improvement.split(' ').join('-');
            className += ' ' + improvementName;
            tileStack.push('improvement improvement-' + improvementName);
        }

        if (cell.myCity || cell.myUnit) {
            tileStack.push('highlight');
            clickable = true;
        }

        if (cell.myCity || cell.rivalCity) {
            tileStack.push('city');
        }

        if (cell.myUnit || cell.rivalUnit) {
            let unit = unitsById[cell.unitId];
            let unitName = unit.unitType.name;
            tileStack.push('unit unit-' + unitName);
        }

        if (!cell.lit) {
            className += ' fog';
            tileStack.push('fog');
        }

        cell.edges.forEach(edge => {
            tileStack.push('edge edge-' + edge);
        });

        if (clickable) {
            className += ' clickable';
            onClick = 'clickMapCell(' + r + ', ' + c + ')';
        }

        if (cell.myUnit || cell.rivalUnit || cell.rivalCity) {
            allowTileEntry = false;
        }
    } else {
        className += ' notDiscovered';
    }
%>

<div class="<%= className %>" row="<%= r %>" column="<%= c %>"
        onMouseover="hoverMapCell(<%= r %>, <%= c %>)"
        onClick="<%= onClick %>">

    <% tileStack.forEach(layer => { %>
        <div class="tile-stack layer-<%= layer %>"> </div>
    <% }); %>

    <% if (allowTileEntry) { %>
        <% cell.moves.forEach(move => { %>
            <form action="<%= move.path %>" method="post"
                class="move-unit <%= move.direction %>"
                unit-id="<%= move.unitId %>"
                onClick="$(this).submit()">
            </form>
        <% }); %>
    <% } %>

    <% cell.workTiles.forEach(workTile => { %>
        <form action="<%= workTile.path %>" method="post"
            class="work-tile working-<%= workTile.working %>"
            city-id="<%= workTile.cityId %>"
            <% if (workTile.working != 'disabled') { %>
                onClick="$(this).submit()"
            <% } %>
            >
        </form>
    <% }); %>
</div>
